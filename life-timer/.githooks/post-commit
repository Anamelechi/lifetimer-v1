#!/usr/bin/env bash
# post-commit hook
# Purpose: Append last commit info to life-timer/COPILOT_NOTES.md via npm script.
# Permanent safeguards to avoid interfering with CI and history rewrites.
# References:
# - Git hooks docs: https://git-scm.com/docs/githooks
# - Rebase state dirs: https://git-scm.com/docs/git-rebase

set -euo pipefail

# Resolve repo paths
REPO_ROOT="$(git rev-parse --show-toplevel)"
GIT_DIR="$(git rev-parse --git-dir)"

# 1) Skip in CI (e.g., GitHub Actions sets CI=true)
if [ -n "${CI:-}" ]; then
	exit 0
fi

# 2) Skip during history operations that replay commits or alter HEAD
#    Detect standard state files/dirs managed by Git
if [ -d "$GIT_DIR/rebase-merge" ] || [ -d "$GIT_DIR/rebase-apply" ] \
	 || [ -f "$GIT_DIR/MERGE_HEAD" ] || [ -f "$GIT_DIR/CHERRY_PICK_HEAD" ] \
	 || [ -f "$GIT_DIR/REVERT_HEAD" ]; then
	exit 0
fi

# 3) Optional manual escape hatch: allow users to opt out per-commit
#    Add [skip notes] in the commit message to bypass the hook
LAST_MSG_FILE="$GIT_DIR/COMMIT_EDITMSG"
if [ -f "$LAST_MSG_FILE" ] && grep -qi "\[skip notes\]" "$LAST_MSG_FILE"; then
	exit 0
fi

# Run the append script from the app directory
SCRIPT_DIR="$REPO_ROOT/life-timer"
cd "$SCRIPT_DIR" || exit 0

# Execute quietly; never fail the commit
npm run --silent postcommit >/dev/null 2>&1 || true
